name: CDK Deployment

on:
  push:
    branches:
      - main

jobs:
    build:
        runs-on: ubuntu-latest
        environment: Production

        steps:
            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
            - name: Install Zig toolchain
              uses: korandoru/setup-zig@v1
              with:
                zig-version: 0.10.0
            - name: Install Cargo Lambda
              uses: jaxxstorm/action-install-gh-release@v1.9.0
              with:
                repo: cargo-lambda/cargo-lambda
                platform: linux
                arch: x86_64 # Other valid options for linux: 'aarch64'

            
            - name: Checkout
              uses: actions/checkout@v3

            - name: cdk synth
              uses: youyo/aws-cdk-github-actions@v2
              with:
                cdk_subcommand: 'synth'
                working_dir: 'cdk'
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

            - name: cdk deploy
              uses: youyo/aws-cdk-github-actions@v2
              with:
                cdk_subcommand: 'deploy'
                working_dir: 'cdk'
              env:
                AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}